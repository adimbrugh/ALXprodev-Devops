#!/bin/bash

# Setup
DATA_DIR="Advanced_shell/pokemon_data"
mkdir -p "$DATA_DIR"
cd Advanced_shell || exit 1

POKEMON_LIST=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")
API_URL="https://pokeapi.co/api/v2/pokemon"
ERROR_FILE="errors_parallel.txt"
> "$ERROR_FILE"

TIMEOUT=10  # seconds

# Function to fetch a Pok√©mon with timeout protection
fetch_pokemon() {
  local pokemon=$1
  local file_path="$DATA_DIR/${pokemon}.json"

  (
    curl -s -w "%{http_code}" -o "$file_path" "$API_URL/$pokemon" > "$file_path.status"
  ) &
  local pid=$!

  # Timeout watchdog
  ( sleep "$TIMEOUT" && kill -0 "$pid" 2>/dev/null && kill "$pid" && echo "‚è∞ Timeout: $pokemon fetch killed." >> "$ERROR_FILE" ) &
  local watchdog=$!

  # Wait for curl process
  wait "$pid"
  curl_status=$?

  # Kill watchdog if not triggered
  kill "$watchdog" 2>/dev/null

  # Handle result
  if [ $curl_status -eq 0 ]; then
    status=$(<"$file_path.status")
    rm -f "$file_path.status"
    if [ "$status" -eq 200 ]; then
      echo "‚úÖ $pokemon downloaded successfully."
    else
      echo "‚ùå Error fetching $pokemon (HTTP $status)" >> "$ERROR_FILE"
      rm -f "$file_path"
    fi
  else
    echo "‚ùå curl failed for $pokemon (exit $curl_status)" >> "$ERROR_FILE"
    rm -f "$file_path"
  fi
}

# Start parallel jobs
for pokemon in "${POKEMON_LIST[@]}"; do
  fetch_pokemon "$pokemon" &
done

# List background jobs
echo -e "\nüõ†Ô∏è Currently running jobs:"
jobs

# Wait for all jobs to finish
wait

# Summary
echo -e "\n‚úÖ All downloads complete."

if [ -s "$ERROR_FILE" ]; then
  echo "‚ö†Ô∏è Some errors occurred. Check $ERROR_FILE"
else
  echo "üéâ All Pok√©mon data fetched successfully with no errors."
fi
